---
title: "Plotting Scene"
output: html_document
---

В этом модуле мы будем использовать библиотеку ggplot2 и plotly для создания интерактивной карты расстановки игроков на поле.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require('plotly'))
{
  install.packages('plotly', dependencies = TRUE)
  library('plotly')
}
if (!require('ggplot2'))
{
  install.packages('ggplot2', dependencies = TRUE)
  library('ggplot2')
}
```

Функция отвечающая за отрисовку называется `plot_scene`. 
Она принимает в качестве аргументов:

- датасеты с координатами двух команд (`offense_df` и `defense_df`)

- координата `x` для мяча - `ball_x` 

- координата `y` для мяча - `ball_y`

- заголовок графика - `title`

Для отрисовки создается поле с разделенными по 10 ярдов зонами, двумя зонами тачдауна для каждой команды и линией положения мяча. В NFL используется игровое поле размером 100 на 53 ярда. Для предотврацения выхода за границы поле в функции ограничено - вылетающие значения обрезаются.

```{r}
plot_scene <- function(offense_df, defense_df, ball_x, ball_y, title) {
  if (ball_x > 109){
    ball_x = 109
  }
  if(ball_x < 11){
    ball_x = 11
  }
  if (ball_y > 52){
    ball_y = 52
  }
  if(ball_y < 1){
    ball_y = 1
  }
  offense_df['role'] = 'offense'
  defense_df['role'] = 'defense'
  n_df <- rbind(offense_df, defense_df)
  ball <- data.frame(x=0, y=0, density=0, type='', Atype=0, role='ball')
  n_df <- rbind(n_df, ball)
  n_df$role <- as.factor(n_df$role)
  plt <- ggplot(n_df) + 
    annotate("rect", xmin=0, xmax=10, ymin=0, ymax=53, fill='red', alpha=.2) + 
    annotate("rect", xmin=110, xmax=120, ymin=0, ymax=53, fill='red', alpha=.2) + 
    annotate("rect", xmin=10, xmax=110, ymin=0, ymax=53, fill='green', alpha=.2) + 
    xlim(0, 120) + ylim(0, 53) + 
    geom_vline(xintercept=seq(0, 120, 10)) + 
    geom_vline(xintercept=ball_x, colour='red') +
    geom_hline(yintercept=seq(0, 53, 53)) + 
    geom_point(mapping=aes(x+ball_x, y+ball_y, colour=role), size=3) + 
    geom_text(mapping=aes(x+ball_x, y+ball_y, label=type), size=2.5) +
    ggtitle(title) +
    xlab("X") +
    ylab("Y") +
    labs(colour="Team") +
    scale_color_manual(values=c("#32CD32", "#6495ED", "#F08080"))
  ggplotly(plt)
}
```

## Загрузка данных

```{r}
off_df <- read.csv('positions_off.csv')
off_df <- off_df[off_df$density > 0,]
off_df <- subset(off_df, select = x:Atype)
def_df <- read.csv('positions_def.csv')
def_df <- def_df[def_df$density > 0,]
def_df <- subset(def_df, select = x:Atype)
```

## Использование

В качестве положений мяча будут координаты (75, 35), (100, 43), (34, 30)

```{r}
plot_scene(off_df, def_df, 75, 35, "Моделирование игры NFL")
```

```{r}
plot_scene(off_df, def_df, 100, 43, "Моделирование игры NFL")
```

```{r}
plot_scene(off_df, def_df, 34, 30, "Моделирование игры NFL")
```