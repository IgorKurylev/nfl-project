---
title: "filtered_heatmapping"
author: "yurkovkirill"
date: "05 01 2021"
output:
  rmarkdown::github_document: default
  #pdf_document: default
---

```{r all, include=TRUE}

# setup

#install.packages("RSQLite")
#devtools::install_github("r-dbi/RSQLite")
library(DBI)
library(ggplot2)
library(dplyr)
#install.packages("tidyverse")
#install.packages("stringr")
#library(tidyverse) # for tibble and others
#library(stringr)

setwd("D:/MyFilesDesktop/Student/7SEM/DataScience/DS_Project")
con <- dbConnect(RSQLite::SQLite(), ":memory:")
dbListTables(con)
options(max.print=10000)

# init database
dbWriteTable(con, "games", read.csv("data/games.csv"))


####
# Add additional column for statistic:
# -success'
plays <- read.csv("data/plays.csv")
plays$success <- 0
plays$success[plays$playResult >= plays$yardsToGo] <- 1
dbWriteTable(con, "plays", plays)

####
dbWriteTable(con, "allWeeks", read.csv("data/week1.csv"))
dbListFields(con, "allWeeks")
dbAppendTable(con, "allWeeks", read.csv("data/week2.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week3.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week4.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week5.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week6.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week7.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week8.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week9.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week10.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week11.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week12.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week13.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week14.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week15.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week16.csv"))
dbAppendTable(con, "allWeeks", read.csv("data/week17.csv"))
dbGetQuery(con, "SELECT COUNT(*) FROM allWeeks")

dbListTables(con)

#dbRemoveTable(con, "games")
#dbRemoveTable(con, "plays")
#dbRemoveTable(con, "allWeeks")


# USE IT
# 1) Берем координаты мяча в момент ball_snap (и считаем относительно него, ориентируясь по playDirection)
# 2) Пересчет их координат относительно


# нужно отобрать всех игроков в моменте, посмотрим не пропадают ли

testTeam <- head(dbGetQuery(con, "SELECT DISTINCT w.nflId, w.team FROM plays as p JOIN allWeeks as w ON p.gameId = w.gameId
                                      AND p.playId = w.playId WHERE w.gameId = 2018090600
                                      ORDER BY w.nflId"),12)#w.event = 'ball_snap'")
testTeam
# этот запрос дал нам понять, что команда у игрока во время игры не меняется, но мы знаем что меняется сторона

testFrames <- head(dbGetQuery(con, "SELECT w.frameId, w.playId, COUNT(w.nflId), COUNT(w.displayName) FROM plays as p JOIN allWeeks as w ON p.gameId = w.gameId
                                      AND p.playId = w.playId WHERE w.gameId = 2018090600
                                      GROUP BY w.frameId, w.playId ORDER BY w.playId"),60)#w.event = 'ball_snap'")
options(max.print=10000)
testFrames
# этот запрос показал, что количество игроков каждом фрейме одного момента одинаковое, поэтому смело можно брать
# ball_snap кадр и мы получим данные о всех зафиксированных игроках в моменте

################################################################################################################
# Обработка данных
################################################################################################################
# информация о защитниках с относительными координатами
##### Нормальный отбор по команде нападения BEGIN
# QUERIES for teams ########################
dbExecute(con, "UPDATE plays as p SET possessionTeam = 'away'
                WHERE possessionTeam != (SELECT homeTeamAbbr FROM games as g WHERE p.gameId = g.gameId)")
dbExecute(con, "UPDATE plays as p SET possessionTeam = 'home'
                WHERE possessionTeam = (SELECT homeTeamAbbr FROM games as g WHERE p.gameId = g.gameId)")
testTeam1 <- dbGetQuery(con, "SELECT team, COUNT(DISTINCT(playId)) FROM allWeeks as w GROUP BY team")
testTeam1

# проверка
testTeamPlay <- dbGetQuery(con, "SELECT possessionTeam, COUNT(DISTINCT(playId)) FROM plays GROUP BY possessionTeam")
testTeamPlay


#######################################################################################################################
# берем информацию по мячу ## MAIN QUERY for init point (ball)
#######################################################################################################################

dbListFields(con, "plays")
# football_inSnap1 <- dbGetQuery(con, "SELECT p.epa, w.x as x_b, w.y as y_b, w.displayName, w.event, w.playId,
#                                       w.gameId, p.offenseFormation, p.possessionTeam, p.yardlineNumber
#                                       FROM plays as p JOIN allWeeks as w ON p.gameId = w.gameId
#                                       AND p.playId = w.playId WHERE w.event = 'ball_snap' AND w.displayName = 'Football'")
dbWriteTable(con, "football_inSnap1", dbGetQuery(con, "SELECT p.epa, w.x as x_b, w.y as y_b, w.displayName, w.event, w.playId,
                                      w.gameId, p.offenseFormation, p.possessionTeam, p.yardlineNumber, p.success
                                      FROM plays as p JOIN allWeeks as w ON p.gameId = w.gameId
                                      AND p.playId = w.playId WHERE w.event = 'ball_snap' AND w.displayName = 'Football'"))
dbListFields(con, "football_inSnap1")
#dbRemoveTable(con, "football_inSnap1")


#### теперь пробуем соединить по команде (home / away) ####
# Красота
DefPlayers_inSnap <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                      w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS
                                      JOIN allWeeks as w ON fS.gameId = w.gameId AND fS.playId = w.playId
                                      WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')")
summary(DefPlayers_inSnap)
DefPlayers_inSnapBest <- DefPlayers_inSnap[DefPlayers_inSnap$epa < -0.76,]
DefPlayers_inSnapWinScr <- DefPlayers_inSnap[DefPlayers_inSnap$success == 0,]
#DefPlayers_inSnapWorst <- DefPlayers_inSnap[DefPlayers_inSnap$epa > 0.97,]
DefPlayers_inSnapBest %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 15)) + #очистка
  labs(title="DefPlayers_inSnapBest")
DefPlayers_inSnapWinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 15)) + #очистка
  labs(title="DefPlayers_inSnapWinScr")

##### У нас получилось учесть всех защитников для обоих команд


##### DIFFERENT TYPES OF OFFENSE #######################################################
### разные типы атак
attackTypes <- dbGetQuery(con, "SELECT offenseFormation, COUNT(playId) FROM plays GROUP BY offenseFormation")
attackTypes

# I_FORM
def_ag_I_FORM <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success  FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'I_FORM'")
summary(def_ag_I_FORM)

def_ag_I_FORM_Best <- def_ag_I_FORM[def_ag_I_FORM$epa < -0.51,]
def_ag_I_FORM_WinScr <- def_ag_I_FORM[def_ag_I_FORM$success == 0,]
#def_ag_I_FORM_Worst <- def_ag_I_FORM[def_ag_I_FORM$epa > 1.13,]

def_ag_I_FORM_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_I_FORM_Best")
def_ag_I_FORM_WinScr %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_I_FORM_BestWinScr")


# SINGLEBACK
def_ag_SINGLEBACK <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'SINGLEBACK'")
summary(def_ag_SINGLEBACK)
def_ag_SINGLEBACK_Best <- def_ag_SINGLEBACK[def_ag_SINGLEBACK$epa < -0.53,]
def_ag_SINGLEBACK_WinScr <- def_ag_SINGLEBACK[def_ag_SINGLEBACK$success == 0,]
#def_ag_SINGLEBACK_Worst <- def_ag_SINGLEBACK[def_ag_SINGLEBACK$epa > 1.10,]

def_ag_SINGLEBACK_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SINGLEBACK_Best")

def_ag_SINGLEBACK_WinScr %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SINGLEBACK_WinScr")


# SHOTGUN
def_ag_SHOTGUN <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'SHOTGUN'")
summary(def_ag_SHOTGUN)
def_ag_SHOTGUN_Best <- def_ag_SHOTGUN[def_ag_SHOTGUN$epa < -0.84,]
def_ag_SHOTGUN_WinScr <- def_ag_SHOTGUN[def_ag_SHOTGUN$success == 0,]
#def_ag_SHOTGUN_Worst <- def_ag_SHOTGUN[def_ag_SHOTGUN$epa > 0.90,]
def_ag_SHOTGUN_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SHOTGUN_Best")
def_ag_SHOTGUN_WinScr %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SHOTGUN_WinScr")

# PISTOL
def_ag_PISTOL <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'PISTOL'")
summary(def_ag_PISTOL)
def_ag_PISTOL_Best <- def_ag_PISTOL[def_ag_PISTOL$epa < -0.59,]
def_ag_PISTOL_WinScr <- def_ag_PISTOL[def_ag_PISTOL$success == 0,]
#def_ag_PISTOL_Worst <- def_ag_PISTOL[def_ag_PISTOL$epa > 1.26,]
def_ag_PISTOL_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.3, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_PISTOL_Best")
def_ag_PISTOL_WinScr %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_PISTOL_WinScr")

# WILDCAT 
def_ag_WILDCAT <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'WILDCAT'")
summary(def_ag_WILDCAT)
def_ag_WILDCAT_Best <- def_ag_WILDCAT[def_ag_WILDCAT$epa < -0.80,]
def_ag_WILDCAT_WinScr <- def_ag_WILDCAT[def_ag_WILDCAT$success == 0,]
#def_ag_WILDCAT_Worst <- def_ag_WILDCAT[def_ag_WILDCAT$epa > 0.50,] 
def_ag_WILDCAT_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_WILDCAT")
def_ag_WILDCAT_WinScr %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_WILDCAT_WinScr")

# JUMBO 
def_ag_JUMBO <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'JUMBO'")
summary(def_ag_JUMBO)
def_ag_JUMBO_Best <- def_ag_JUMBO[def_ag_JUMBO$epa < -0.31,]
def_ag_JUMBO_WinScr <- def_ag_JUMBO[def_ag_JUMBO$success == 0,]
#def_ag_JUMBO_Worst <- def_ag_JUMBO[def_ag_JUMBO$epa > 1.38,] 
def_ag_JUMBO_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_JUMBO_Best")
def_ag_JUMBO_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_JUMBO_WinScr")

# EMPTY
def_ag_EMPTY <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap' AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'EMPTY'")
summary(def_ag_EMPTY)
def_ag_EMPTY_Best <- def_ag_EMPTY[def_ag_EMPTY$epa < -0.85,]
def_ag_EMPTY_WinScr <- def_ag_EMPTY[def_ag_EMPTY$success == 0,]
#def_ag_EMPTY_Worst <- def_ag_EMPTY[def_ag_EMPTY$epa > 1.04,]
def_ag_EMPTY_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_EMPTY_Best")
def_ag_EMPTY_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_EMPTY_WinScr")

######################################################################################################################
### разные по ярдлиниям 
# 0-10
def_yl_0_10 <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS
                                  JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap'
                                  AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 0 AND fS.yardlineNumber <= 10")
summary(def_yl_0_10)
def_yl_0_10_Best <- def_yl_0_10[def_yl_0_10$epa < -0.55,]
def_yl_0_10_WinScr <- def_yl_0_10[def_yl_0_10$success == 0,]
#def_yl_0_10_Worst <- def_yl_0_10[def_yl_0_10$epa > 1.45,]
def_yl_0_10_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best def on yardline 0-10")
def_yl_0_10_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Win def on yardline 0-10")

# 10-20
def_yl_10_20 <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS
                                  JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap'
                                  AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 10 AND fS.yardlineNumber <= 20")
summary(def_yl_10_20)
def_yl_10_20_Best <- def_yl_10_20[def_yl_10_20$epa < -0.72,]
def_yl_10_20_WinScr <- def_yl_10_20[def_yl_10_20$success == 0,]
#def_yl_10_20_Worst <- def_yl_10_20[def_yl_10_20$epa > 0.99,]
def_yl_10_20_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best def on yardline 10-20")
def_yl_10_20_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Win def on yardline 10-20")

# 20-35
def_yl_20_35 <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS
                                  JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap'
                                  AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 20 AND fS.yardlineNumber <= 35")
summary(def_yl_20_35)
def_yl_20_35_Best <- def_yl_20_35[def_yl_20_35$epa < -0.77,]
def_yl_20_35_WinScr <- def_yl_20_35[def_yl_20_35$success == 0,]
#def_yl_20_35_Worst <- def_yl_20_35[def_yl_20_35$epa > 0.94,]
def_yl_20_35_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best def on yardline 20-35")
def_yl_20_35_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Win def on yardline 20-35")

# 35-50
def_yl_35_50 <- dbGetQuery(con, "SELECT fS.epa, abs(w.x - x_b) as x_rel, (w.y - y_b) as y_rel, w.displayName, w.playId,
                                  w.gameId, w.team, w.playDirection, fS.success FROM football_inSnap1 as fS
                                  JOIN allWeeks as w ON fS.gameId = w.gameId
                                  AND fS.playId = w.playId WHERE w.event = 'ball_snap'
                                  AND w.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 35 AND fS.yardlineNumber <= 50")
summary(def_yl_35_50)
def_yl_35_50_Best <- def_yl_35_50[def_yl_35_50$epa < -0.79,]
def_yl_35_50_WinScr <- def_yl_35_50[def_yl_35_50$success == 0,]
#def_yl_35_50_Worst <- def_yl_35_50[def_yl_35_50$epa > 0.94,]
def_yl_35_50_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best def on yardline 35-50")
def_yl_35_50_WinScr %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Win def on yardline 35-50")




# сравнить Worst
# сделать по play Result, сравнить #Done

# Pending2 для разных типов игроков!!! можно для разных типов атак просто выяснить


# end

dbDisconnect(con)


```


