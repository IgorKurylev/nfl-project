---
title: "filtered_heatmapping"
author: "yurkovkirill"
date: "05 01 2021"
output:
  rmarkdown::github_document: default
  #pdf_document: default
---

```{r all, include=TRUE}


# setup

#install.packages("RSQLite")
#devtools::install_github("r-dbi/RSQLite")
library(DBI)
library(ggplot2)
library(dplyr)
#install.packages("tidyverse")
#install.packages("stringr")
#library(tidyverse) # for tibble and others
#library(stringr)

setwd("D:/MyFilesDesktop/Student/7SEM/DataScience/DS_Project")
con <- dbConnect(RSQLite::SQLite(), ":memory:")
dbListTables(con)
options(max.print=10000)

# init database
dbWriteTable(con, "games", read.csv("data/games.csv"))
dbWriteTable(con, "plays", read.csv("data/plays.csv"))
dbWriteTable(con, "week1", read.csv("data/week1.csv"))
dbListTables(con)



# USE IT
# 1) Берем координаты мяча в момент ball_snap (и считаем относительно него, ориентируясь по playDirection)
# 2) Пересчет их координат относительно


# нужно отобрать всех игроков в моменте, посмотрим не пропадают ли

testTeam <- dbGetQuery(con, "SELECT DISTINCT w1.nflId, w1.team FROM plays as p JOIN week1 as w1 ON p.gameId = w1.gameId
                                      AND p.playId = w1.playId WHERE w1.gameId = 2018090600
                                      ORDER BY w1.nflId")#w1.event = 'ball_snap'")
head(testTeam,60)
# этот запрос дал нам понять, что команда у игрока во время игры не меняется, но мы знаем что меняется сторона
# поэтому сделаем для всех игроков относительно мяча и playDirection, и получим в одном случае защиту справа
# а в другом защиту слева. Потом отобрать по o = orientation? Больше никак вроде #Pending


testFrames <- dbGetQuery(con, "SELECT w1.frameId, w1.playId, COUNT(w1.nflId), COUNT(w1.displayName) FROM plays as p JOIN week1 as w1 ON p.gameId = w1.gameId
                                      AND p.playId = w1.playId WHERE w1.gameId = 2018090600
                                      GROUP BY w1.frameId, w1.playId ORDER BY w1.playId")#w1.event = 'ball_snap'")
options(max.print=10000)
head(testFrames,60)
# этот запрос показал, что количество игроков каждом фрейме одного момента одинаковое, поэтому смело можно брать
# ball_snap кадр и мы получим данные о всех зафиксированных игроках в моменте

################################################################################################################
# информация о защитниках с относительными координатами
##### Нормальный отбор по команде нападения BEGIN
# QUERIES for teams ########################
dbExecute(con, "UPDATE plays as p SET possessionTeam = 'away'
                WHERE possessionTeam != (SELECT homeTeamAbbr FROM games as g WHERE p.gameId = g.gameId)")
dbExecute(con, "UPDATE plays as p SET possessionTeam = 'home'
                WHERE possessionTeam = (SELECT homeTeamAbbr FROM games as g WHERE p.gameId = g.gameId)")
testTeam1 <- dbGetQuery(con, "SELECT team, COUNT(DISTINCT(nflId)) FROM week1 as w1 GROUP BY team")
testTeam1

# проверка
testTeamPlay <- dbGetQuery(con, "SELECT possessionTeam, COUNT(DISTINCT(playId)) FROM plays GROUP BY possessionTeam")
testTeamPlay

# берем информацию по мячу ## MAIN QUERY for init point (ball)
dbListFields(con, "plays")
football_inSnap1 <- dbGetQuery(con, "SELECT p.epa, w1.x as x_b, w1.y as y_b, w1.displayName, w1.event, w1.playId,
                                      w1.gameId, p.offenseFormation, p.possessionTeam, p.yardlineNumber
                                      FROM plays as p JOIN week1 as w1 ON p.gameId = w1.gameId
                                      AND p.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.displayName = 'Football'")
dbWriteTable(con, "football_inSnap1", football_inSnap1)
dbListFields(con, "football_inSnap1")
#dbRemoveTable(con, "football_inSnap1")


#### теперь пробуем соединить по команде (home / away) ####
# Красота
DefPlayers_inSnap <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                      w1.gameId, w1.team, w1.playDirection FROM football_inSnap1 as fS
                                      JOIN week1 as w1 ON fS.gameId = w1.gameId AND fS.playId = w1.playId
                                      WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')")
summary(DefPlayers_inSnap)
DefPlayers_inSnapBest <- DefPlayers_inSnap[DefPlayers_inSnap$epa < -0.86,]
DefPlayers_inSnapWorst <- DefPlayers_inSnap[DefPlayers_inSnap$epa > 0.84,]
DefPlayers_inSnapBest %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="DefPlayers_inSnapBest NEW")

##### У нас получилось учесть всех защитников для обоих команд


##### DIFFERENT TYPES OF OFFENSE #######################################################
### разные типы атак
attackTypes <- dbGetQuery(con, "SELECT offenseFormation, COUNT(playId) FROM plays GROUP BY offenseFormation")
attackTypes

# I_FORM
def_ag_I_FORM_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'I_FORM'")
summary(def_ag_I_FORM_1)

def_ag_I_FORM_1_Best <- def_ag_I_FORM_1[def_ag_I_FORM_1$epa < -0.48,]
def_ag_I_FORM_1_Worst <- def_ag_I_FORM_1[def_ag_I_FORM_1$epa > 1.13,]

def_ag_I_FORM_1_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_I_FORM_1_Best")


# SINGLEBACK
def_ag_SINGLEBACK_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'SINGLEBACK'")
summary(def_ag_SINGLEBACK_1)
def_ag_SINGLEBACK_1_Best <- def_ag_SINGLEBACK_1[def_ag_SINGLEBACK_1$epa < -0.55,]
def_ag_SINGLEBACK_1_Worst <- def_ag_SINGLEBACK_1[def_ag_SINGLEBACK_1$epa > 1.02,]

def_ag_SINGLEBACK_1_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SINGLEBACK_Best")


# SHOTGUN
def_ag_SHOTGUN_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'SHOTGUN'")
summary(def_ag_SHOTGUN_1)
def_ag_SHOTGUN_1_Best <- def_ag_SHOTGUN_1[def_ag_SHOTGUN_1$epa < -0.91,]
def_ag_SHOTGUN_1_Worst <- def_ag_SHOTGUN_1[def_ag_SHOTGUN_1$epa > 0.77,]
def_ag_SHOTGUN_1_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_SHOTGUN_Best")

# PISTOL
def_ag_PISTOL_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'PISTOL'")
summary(def_ag_PISTOL_1)
def_ag_PISTOL_1_Best <- def_ag_PISTOL_1[def_ag_PISTOL_1$epa < -0.18,]
def_ag_PISTOL_1_Worst <- def_ag_PISTOL_1[def_ag_PISTOL_1$epa > 0.84,]
def_ag_PISTOL_1_Best %>%
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_PISTOL_Best")

# WILDCAT #more weeks # lowPending 3.1
def_ag_WILDCAT_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'WILDCAT'")
summary(def_ag_WILDCAT_1)
def_ag_WILDCAT_1_Best <- def_ag_WILDCAT_1[def_ag_WILDCAT_1$epa < -0.56,] # lowPending 3.1
def_ag_WILDCAT_1_Worst <- def_ag_WILDCAT_1[def_ag_WILDCAT_1$epa > 1.23,] # lowPending 3.1
def_ag_WILDCAT_1 %>% # lowPending 3.1
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_WILDCAT_1")

# JUMBO #Pending 3.1
def_ag_JUMBO_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'JUMBO'")
summary(def_ag_JUMBO_1)
def_ag_JUMBO_1_Best <- def_ag_JUMBO_1[def_ag_JUMBO_1$epa < -0.56,] # lowPending 3.1
def_ag_JUMBO_1_Worst <- def_ag_JUMBO_1[def_ag_JUMBO_1$epa > 1.23,] # lowPending 3.1
def_ag_JUMBO_1 %>% # lowPending 3.1
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_JUMBO_Best")

# EMPTY
def_ag_EMPTY_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap' AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.offenseFormation = 'EMPTY'")
summary(def_ag_EMPTY_1)
def_ag_EMPTY_1_Best <- def_ag_EMPTY_1[def_ag_EMPTY_1$epa < -0.90,]
def_ag_EMPTY_1_Worst <- def_ag_EMPTY_1[def_ag_EMPTY_1$epa > 0.60,]
def_ag_EMPTY_1_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="def_ag_EMPTY_Best")


### разные по ярдлиниям 
# 0-10
def_yl_0_10_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS
                                  JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap'
                                  AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 0 AND fS.yardlineNumber <= 10")
summary(def_yl_0_10_1)
def_yl_0_10_1_Best <- def_yl_0_10_1[def_yl_0_10_1$epa < -0.78,]
def_yl_0_10_1_Worst <- def_yl_0_10_1[def_yl_0_10_1$epa > 0.48,]
def_yl_0_10_1_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best right def on yardline 0-10")

# 10-20
def_yl_10_20_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS
                                  JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap'
                                  AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 10 AND fS.yardlineNumber <= 20")
summary(def_yl_10_20_1)
def_yl_10_20_1_Best <- def_yl_10_20_1[def_yl_10_20_1$epa < -0.86,]
def_yl_10_20_1_Worst <- def_yl_10_20_1[def_yl_10_20_1$epa > 0.93,]
def_yl_10_20_1_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best right def on yardline 10-20")

# 20-35

def_yl_20_35_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS
                                  JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap'
                                  AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 20 AND fS.yardlineNumber <= 35")
summary(def_yl_20_35_1)
def_yl_20_35_1_Best <- def_yl_20_35_1[def_yl_20_35_1$epa < -0.92,]
def_yl_20_35_1_Worst <- def_yl_20_35_1[def_yl_20_35_1$epa > 0.70,]
def_yl_20_35_1_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best right def on yardline 20-35")

# 35-50
def_yl_35_50_1 <- dbGetQuery(con, "SELECT fS.epa, abs(w1.x - x_b) as x_rel, (w1.y - y_b) as y_rel, w1.displayName, w1.playId,
                                  w1.gameId, w1.team, w1.playDirection  FROM football_inSnap1 as fS
                                  JOIN week1 as w1 ON fS.gameId = w1.gameId
                                  AND fS.playId = w1.playId WHERE w1.event = 'ball_snap'
                                  AND w1.team NOT IN(fS.possessionTeam, 'football')
                                  AND fS.yardlineNumber > 35 AND fS.yardlineNumber <= 50")
summary(def_yl_35_50_1)
def_yl_35_50_1_Best <- def_yl_35_50_1[def_yl_35_50_1$epa < -0.78,]
def_yl_35_50_1_Worst <- def_yl_35_50_1[def_yl_35_50_1$epa > 0.95,]
def_yl_35_50_1_Best %>% 
  ggplot(aes(x = x_rel, y = y_rel)) +
  geom_density2d_filled(contour_var = "ndensity", breaks = seq(0.2, 1.0, length.out = 10)) + #очистка
  labs(title="Best right def on yardline 35-50")



# Учесть под разные типы расположения! Какой лучше выбрать и как лучше делать под определенное расположение
# например WILDCAT #Pending1

# Pending2 для разных типов игроков

# Pending3 в games есть homeTeamAbbr, выделять команду можно по нему
# То есть w1.playDirection = 'right' AND  x_rel >= 0 заменится на w1.замененный team из homeTeamAbbr != p.possessionTeam

#Pending4 сделать для всех week



###HEATMAP + поле 
# playsWeek1 %>%
#   ggplot(aes(x = x_cor, y = y_cor)) +
#   geom_density2d_filled() +
#   theme(legend.position = "none") + add_field()
# Pending


# end

dbDisconnect(con)
```


